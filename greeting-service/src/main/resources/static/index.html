<!--
  ~
  ~  Copyright 2016-2017 Red Hat, Inc, and individual contributors.
  ~
  ~  Licensed under the Apache License, Version 2.0 (the "License");
  ~  you may not use this file except in compliance with the License.
  ~  You may obtain a copy of the License at
  ~
  ~  http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~  Unless required by applicable law or agreed to in writing, software
  ~  distributed under the License is distributed on an "AS IS" BASIS,
  ~  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~  See the License for the specific language governing permissions and
  ~  limitations under the License.
  ~
  -->
<html>

<head>
    <meta charset="utf-8">
    <title>Circuit Breaker Mission - Spring Boot</title>
    <link rel="stylesheet"
          href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
          integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
          crossorigin="anonymous">

    <style>
        ul {
            list-style-type: none;
        }

        li {
            display: block;
        }

        .from0 {
            background-color: maroon;
        }

        .from1 {
            background-color: aquamarine;
        }

        .from2 {
            background-color: aqua;
        }

        .from3 {
            background-color: bisque;
        }

        .from4 {
            background-color: green;
        }

        .from5 {
            background-color: blue;
        }

        .from6 {
            background-color: blueviolet;
        }

        .from7 {
            background-color: cyan;
        }

        .from8 {
            background-color: darkcyan;
        }

        .from9 {
            background-color: brown;
        }

        .from10 {
            background-color: chocolate;
        }

        .from11 {
            background-color: fuchsia;
        }

        .from12 {
            background-color: crimson;
        }

        .from13 {
            background-color: darkorange;
        }

        .from14 {
            background-color: red;
        }

        .from15 {
            background-color: grey;
        }

        .from16 {
            background-color: yellow;
        }

        .from17 {
            background-color: orange;
        }

        .from18 {
            background-color: white;
        }

        .from19 {
            background-color: pink;
        }
    </style>
</head>

<body>

<div class="container">

    <div>
        <h1>Circuit Breaker Mission - Spring Boot</h1>
        <p class="lead">
            Cloud applications are often comprised of many services. And between those services there often can be many interactions.
            But even if some of those services fail or are unavailable, we may want to offer an alternative response to an error condition,
            that it does not increase load on service in, which is unavailable because of high load. And to achieve this, we need a generic
            mechanism over the failed or unavailable service to service communication, which can quickly and easily determine that the services
            are not functioning properly, hence can either return a default result or fail quickly and gracefully with enough information about
            the current failure. This mechanism is called circuit breaker.
        </p>
        <p>
            On this page you can invoke the <code>greeting service</code>. This service uses a <code>name
            service</code>. The invocations are protected by a circuit breaker. You can select the number of concurrent calls to
            the <code>name service</code> that will be made using the number input field then click the <code>Start</code>
            button to start
            calling the <code>name service</code>. Press the <code>Stop</code> button to stop sending requests.
        </p>

        <div class="row">

            <div class="col-md-6">
                <div class="row">
                    <h2>Greeting service</h2>
                </div>
                <div class="row">
                    <div class="col-md-3">
                        <div class="input-group">
                            <span class="input-group-addon" id="basic-addon1">#</span>
                            <input type="number" class="form-control" id="max-concurrent" value="10" min="1" max="20"
                                   placeholder="Max concurrent requests" aria-describedby="basic-addon1"/>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <button id="invoke" type="submit" class="btn btn-primary">Start</button>
                        <button id="stop" type="submit" class="btn btn-danger">Stop</button>
                    </div>
                </div>
                <div class="row">
                    <h3>Results:</h3>
                    <form class="form-inline">
                        <button id="clear" type="submit" class="btn btn-success">Clear</button>
                    </form>
                    <ul id="greeting-result"></ul>
                </div>
            </div>

            <div class="col-md-6">
                <div class="row">
                    <h2>Name service</h2>
                </div>
                <div class="row">
                    OK calls: <span id="callsOK"></span> / Failed calls: <span id="callsFailed"></span> / Ratio: <span id="ratio"></span>
                </div>
                <div class="row">
                    <h3>Requests:</h3>
                    <form class="form-inline">
                        <button id="clear-requests" type="submit" class="btn btn-success">Clear</button>
                    </form>
                    <ul id="name-requests"></ul>
                </div>
            </div>

        </div>

    </div>

    <script
            src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script
            src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
            integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
            crossorigin="anonymous"></script>

    <script>
        var currentLocation = window.location.origin;
        var nameServiceUrlBase = currentLocation.indexOf("localhost") !== -1 ? "http://localhost:8081" : currentLocation.replace("greeting", "name");

        $(document).ready(function () {
            var workers;
            const FROM_STR = 'from';
            const FROM_LEN = FROM_STR.length;
            const FALLBACK = 'Fallback';
            var callsOK = 0, callsFailed = 0;


            function extractFrom(msg) {
                var index = msg.lastIndexOf(FROM_STR);
                if (index !== -1) {
                    return msg.substring(index + FROM_LEN + 1);
                }
                return "";
            }

            function doStats(msg) {
                if (msg.indexOf(FALLBACK) !== -1) {
                    callsFailed++
                } else {
                    callsOK++;
                }

                $("#callsOK").text(callsOK);
                $("#callsFailed").text(callsFailed);
                $("#ratio").text(callsFailed/callsOK);
            }

            $("#invoke").click(function (e) {
                var workerNumber = Number.parseInt($('#max-concurrent').val());
                workers = [];

                for (var i = 0; i < workerNumber; i++) {
                    var worker = new Worker('worker.js');
                    worker.onerror = function (e) {
                        console.log(e)
                    };
                    worker.onmessage = function (e) {
                        var msg = e.data.content;
                        doStats(msg);
                        $("#greeting-result").prepend("<li class='from" + e.data.from + "'>" + JSON.stringify(msg) + "</li>");
                    };
                    worker.timer = setInterval(function (from) {
                        worker.postMessage({'from': from})
                    }, ((Math.random() * i * 100) + 200), i);

                    workers[i] = worker;
                }

                e.preventDefault();
            });

            $("#stop").click(function (e) {
                if (workers) {
                    for (var i = 0; i < workers.length; i++) {
                        workers[i].terminate();
                        clearInterval(workers.timer);
                    }

                    workers = undefined;
                }

                e.preventDefault();
            });

            $("#clear").click(function (e) {
                $("#greeting-result").html("");
                e.preventDefault();
            });

            $("#clear-requests").click(function (e) {
                $("#name-requests").html("");
                e.preventDefault();
            });


            // SSE
            function connect() {
                var nameStateSource = new EventSource(nameServiceUrlBase + '/name-sse');
                nameStateSource.addEventListener('message', function (e) {
                    // Request accepted
                    $("#name-requests").prepend("<li class='from" + extractFrom(e.data) + "'>" + e.data + "</li>");
                }, false);
            }

            window.addEventListener("load", connect, false);
        });
    </script>
</div>
</body>

</html>